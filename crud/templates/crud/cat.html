{% extends 'crud/base.html' %}
{% load crispy_forms_tags %}

{% block title %}
{{ cat.name }}
{% endblock %}

{% block content %}
<div class="container">
	<div class="jumbotron">
		<h2>–ò–º—è –∫–æ—Ç–∞: {{ cat.name }}</h2>
		<ul>
			<li>–ü–æ–ª: {{ cat.get_sex_display }}</li>
			<li>–ü–æ—Ä–æ–¥–∞: {{ cat.breed }}</li>
			<li>–•–æ–∑—è–∏–Ω: {{ cat.owner }}</li>
			<li>–í–æ–∑—Ä–∞—Å—Ç: {{ cat.age }} –≥–æ–¥(a)</li>
			<li>–í–æ–ª–æ—Å–∞—Ç–æ—Å—Ç—å: {{ cat.get_hair_display }}</li>
			<li style="list-style: none;"><span class="likes">{{ total_likes }}</span> <a style="text-decoration: none;" href="" data-cat-id="{{ cat.id }}" data-user-id="{{ request.user.id }}" class="like"><span class="heart">{% if liked %}üíú{% else %}ü§ç{% endif %}</span></a></li>
		</ul>

		{% if request.user == cat.owner %}
			<p><a href="{% url 'crud:update_cat' cat.id %}">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ—Ç–∞</a></p>
			<p><a href="{% url 'crud:del_cat' cat.id %}">–£–¥–∞–ª–∏—Ç—å –∫–æ—Ç–∞</a></p>
		{% endif %}
		<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
		{% if comments %}
			<ul>
				{% for comment in comments %}
					{% if comment.deleted %}
						<li><del style="color: rebeccapurple;">{{ comment.commentator }} - {{ comment.body }}</del></li>
					{% else %}
						<li><span style="color:gray;">{{ comment.commentator }}</span> {{ comment.body }} {% if comment.commentator == request.user %}<a href="{% url 'act:com_del' comment.id %}" style="color: red;"> X</a>{% endif %}</li>
					{% endif %}
				{% endfor %}
			</ul>
		{% else %}
			<h5 style="color: gray;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç</h5>
		{% endif %}
		{% if request.user.is_authenticated %}
			<div style="font-size: 0.8em;">
				<h3 style="font-size: 17px;">–û—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
				<form method="POST" class="">
					{% csrf_token %}
					{{ form|crispy }}
					<button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å!</button>
				</form>
			</div>
		{% endif %}
	</div>
</div>
{% endblock %}

{% block script %}

function getCount() {
	let button = document.querySelector('.like');
	let likedCount = document.querySelector('.likes');
	$.ajax({
		url: "{% url 'act:like_count' %}",
		type: "get",
		data: {cat_id: button.dataset.catId},
		headers: {'X-CSRFToken': '{{ csrf_token }}'},
		success: function(data) {
			likedCount.textContent = data['count'];
		}
	});
}

$(document).ready(function() {
	getCount();
	setInterval('getCount()', 2000);
	let button = document.querySelector('.like');

	button.onclick = function(e) {
		e.preventDefault();
		$.ajax({
			url: "{% url 'act:like_ajax' %}",
			type: "post",
			data: {cat_id: button.dataset.catId, user_id: button.dataset.userId},
			headers: {'X-CSRFToken': '{{ csrf_token }}'},
			success: function(data) {
				let likedCount = document.querySelector('.likes');
				let heart = document.querySelector('.heart')
				if (data['status'] == 'liked'){
					likedCount.textContent++;
					heart.textContent = 'üíú';
				}
				if (data['status'] == 'unliked') {
					likedCount.textContent--;
					heart.textContent = 'ü§ç';
				}
			}
		});
	};
});
{% endblock %}
